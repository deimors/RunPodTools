<!DOCTYPE html>
<html>
<head>
    <title>Lazy WebP Gallery</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: sans-serif; margin: 0; padding: 1em; background: #f8f8f8; }
        #main-content {
            margin-left: 120px; /* Increase margin to avoid toolbar overlap */
            margin-top: 70px; /* Adjust based on header height */
        }
        #main-heading {
            font-size: 2em; /* Increase font size */
            font-weight: bold; /* Make text bold */
            color: #555; /* Darker color for better contrast */
            text-align: left; /* Align the header to the left */
            margin-top: 0;
            margin-bottom: 1em; /* Add spacing below the header */
            border-bottom: 2px solid #ddd; /* Add a subtle underline */
            padding-bottom: 0.5em; /* Add padding below the text */
            position: fixed;
            top: 0;
            left: 4em;
            width: 100%;
            background-color: #f8f8f8; /* Adjust as needed */
            z-index: 1000; /* Ensure it stays above other elements */
            padding: 0.5em 0.5em 0.25em 0; /* Add padding for better spacing */
        }
        #sort-controls {
            position: fixed;
            top: 1.8em; /* Adjust positioning */
            right: 1em; /* Ensure it doesn't spill off the screen */
            display: flex;
            align-items: center;
            gap: 0.3em; /* Reduce gap between controls */
            font-size: 0.5em; /* Make controls smaller */
        }
        #sort-controls select {
            padding: 0.2em; /* Reduce padding */
            border: 1px solid #ccc; /* Slightly lighter border */
            border-radius: 3px; /* Smaller border radius */
            font-size: 0.8em; /* Match font size */
        }
        .gallery { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1em;
            grid-auto-rows: 1fr; /* Make grid items take equal height */
        }
        .gallery .image-container {
            position: relative;
            width: 100%;
            border: 2px solid transparent; /* Default border */
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        .gallery .image-wrapper {
            position: relative; /* Make this a positioning context for sort-value */
        }
        .gallery img {
            display: block;
            width: 100%;
            height: auto; /* Keep aspect ratio */
            object-fit: contain; /* Ensure entire image is visible */
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .gallery .checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            display: none; /* Hidden by default */
            width: 24px; /* Double the default size */
            height: 24px; /* Double the default size */
            cursor: pointer; /* Add pointer cursor for better UX */
            accent-color: #0078d7; /* Match the theme color */
        }
        .gallery .image-container:hover .checkbox,
        .gallery .image-container.selected .checkbox {
            display: block; /* Show checkbox on hover or if selected */
        }
        .gallery .image-container .sort-value {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 10;
        }
        #loading { text-align: center; margin: 2em; font-size: 1.2em; color: #888; }
        #drop-area {
            border: 2px dashed #888;
            border-radius: 8px;
            background: #fff;
            padding: 2em;
            margin-bottom: 2em;
            text-align: center;
            color: #888;
            transition: border-color 0.2s;
        }
        #drop-area.dragover {
            border-color: #0078d7;
            color: #0078d7;
            background: #e6f2ff;
        }
        #upload-status {
            margin-top: 1em;
            color: #007800;
        }
        #toolbar {
            position: fixed;
            top: 1em;
            left: 1em;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            padding: 0.5em;
            z-index: 1000;
            width: auto; /* Adjust width for icon-only buttons */
        }
        #toolbar button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px; /* Just wide enough for the icon */
            height: 40px; /* Square buttons */
            margin-bottom: 0.5em;
            background: #0078d7;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2em; /* Increase icon size by 50% */
            position: relative;
        }
        #toolbar button:hover {
            background: #005fa3;
        }
        #toolbar button.active {
            background: #005fa3; /* Highlight active button */
        }
        #toolbar button i {
            margin: 0; /* Center icon */
        }
        #toolbar button::after {
            content: attr(data-label); /* Tooltip text from data-label attribute */
            position: absolute;
            left: 50px; /* Position tooltip to the right of the button */
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 0.3em 0.6em;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: nowrap;
            display: none; /* Hidden by default */
            z-index: 1001;
        }
        #toolbar button:hover::after {
            display: block; /* Show tooltip on hover */
        }
        #drop-area {
            display: none; /* Hide upload control by default */
        }
        #drop-area.visible {
            display: block; /* Show upload control when active */
        }
        #lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column; /* Stack image and info vertically */
            z-index: 2000;
        }
        #lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        #lightbox-info {
            margin-top: 10px; /* Add spacing beneath the image */
            color: #fff;
            font-size: 0.9em;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
        }
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 3000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 300px;
            text-align: center;
        }
        .modal-content h2 {
            margin: 0 0 1em 0;
            font-size: 1.5em;
            color: #333;
        }
        .modal-content input {
            width: 100%;
            padding: 0.5em;
            margin-bottom: 1em;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        .modal-content button {
            width: 100%;
            padding: 0.5em;
            background: #0078d7;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 0.5em;
        }
        .modal-content button:hover {
            background: #005fa3;
        }

        .toolbar-group {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 1em;
            padding: 0.8em 0.6em 0.2em;
            position: relative;
        }
        .toolbar-group:first-of-type {
            margin-top: 0.3em; /* Remove top margin for the first group */
        }
        .toolbar-group-title {
            position: absolute;
            top: -0.6em;
            left: 10px;
            background: #fff;
            padding: 0 0.3em;
            font-size: calc(100% / 1.5); /* Dynamically adjust font size to fit the width */
            color: #aaa;
            font-weight: normal;
            text-align: center; /* Center-align the group names */
        }
        .gallery .image-container .sort-value {
            position: absolute;
            bottom: 8px; /* Fixed distance from bottom of container */
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 10; /* Ensure it's above the image */
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <div class="toolbar-group">
            <div class="toolbar-group-title">Folders</div>
            <button id="gallery-btn" class="active" data-label="Gallery"><i class="fas fa-images"></i></button>
            <button id="uploads-btn" data-label="Uploads"><i class="fas fa-upload"></i></button>
            <button data-label="Zips"><i class="fas fa-file-archive"></i></button>
        </div>
        <div class="toolbar-group">
            <div class="toolbar-group-title">Select</div>
            <button id="select-all-btn" data-label="Select All"><i class="fas fa-check-square"></i></button>
            <button id="clear-selection-btn" data-label="Clear Selection"><i class="fas fa-times-circle"></i></button>
        </div>
        <div class="toolbar-group">
            <div class="toolbar-group-title">Actions</div>
            <button id="zip-selected-btn" data-label="Zip Selected"><i class="fas fa-file-zipper"></i></button>
            <button id="delete-selected-btn" data-label="Delete Selected"><i class="fas fa-trash"></i></button>
        </div>
    </div>
    <div id="main-content">
        <h1 id="main-heading">
            Gallery
            <div id="sort-controls">
                <label for="sort-by">Sort By:</label>
                <select id="sort-by">
                    <option value="date" selected>Date</option>
                    <option value="filename">Filename</option>
                    <option value="size">Size</option>
                </select>
                <label for="sort-dir">Order:</label>
                <select id="sort-dir">
                    <option value="asc" selected>Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>
        </h1>
        <div id="drop-area">
            <p>Drag &amp; drop a .webp, .jpg, .jpeg, or .png file here to upload,<br>or click to select a file.</p>
            <input type="file" id="fileElem" accept=".webp,.jpg,.jpeg,.png" style="display:none" />
            <div id="upload-status"></div>
        </div>
        <div class="gallery" id="gallery"></div>
        <div id="loading">Loading...</div>
    </div>
    <div id="lightbox">
        <img id="lightbox-img" src="" alt="Lightbox Image">
        <div id="lightbox-info"></div>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <!-- Delete Confirmation Step -->
            <div id="delete-confirmation" style="display: none;">
                <h2 id="modal-title">Delete Confirmation</h2>
                <button id="delete-btn" style="width: 100%; padding: 0.5em; background: #d9534f; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-bottom: 0.5em;">Delete</button>
            </div>

            <!-- Zip Filename Input Step -->
            <div id="zip-filename-step" style="display: none;">
                <h2 id="modal-title">Enter Filename</h2>
                <input type="text" id="zip-filename" placeholder="Enter zip filename" style="width: 100%; padding: 0.5em; margin-bottom: 1em; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
                <button id="zip-btn" style="width: 100%; padding: 0.5em; background: #0078d7; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-bottom: 0.5em;">Zip</button>
            </div>

            <!-- Zip Progress Step -->
            <div id="zip-progress-step" style="display: none;">
                <h2 id="modal-title">Zipping Files...</h2>
                <div id="modal-progress" style="text-align: center; font-size: 1.2em; color: #888;">Please wait...</div>
            </div>

            <!-- Zip Download Step -->
            <div id="zip-download-step" style="display: none;">
                <h2 id="modal-title">Zip Completed</h2>
                <button id="download-btn" style="width: 100%; padding: 0.5em; background: #0078d7; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-bottom: 0.5em;">Download</button>
            </div>
        </div>
    </div>
    <script>
        let page = 0;
        let loading = false;
        let done = false;
        let currentDir = "webp"; // Default to WebP directory
        let lastSelectedIndex = -1; // Track the last selected image index

        const gallery = document.getElementById("gallery");
        const loadedImages = new Map();
        const mainHeading = document.getElementById("main-heading");
        const galleryBtn = document.getElementById("gallery-btn");
        const uploadsBtn = document.getElementById("uploads-btn");
        const dropArea = document.getElementById("drop-area");
        const lightbox = document.getElementById("lightbox");
        const lightboxImg = document.getElementById("lightbox-img");
        const modal = document.getElementById("modal");
        const modalTitle = document.getElementById("modal-title"); // Define modalTitle
        const zipFilenameInput = document.getElementById("zip-filename"); // Define zipFilenameInput
        const zipBtn = document.getElementById("zip-btn"); // Ensure consistent usage of "zip-btn"
        const modalProgress = document.getElementById("modal-progress");
        const downloadBtn = document.getElementById("download-btn");
        const lightboxInfo = document.getElementById("lightbox-info");
        const sortBy = document.getElementById("sort-by");
        const sortDir = document.getElementById("sort-dir");

        const modalSteps = {
            deleteConfirmation: document.getElementById("delete-confirmation"),
            zipFilenameStep: document.getElementById("zip-filename-step"),
            zipProgressStep: document.getElementById("zip-progress-step"),  
            zipDownloadStep: document.getElementById("zip-download-step")
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const imgContainer = entry.target;
                const img = imgContainer.querySelector('img');
                if (entry.isIntersecting) {
                    if (!img.dataset.src) return;
                    img.src = img.dataset.static || img.dataset.src;
                    loadedImages.set(imgContainer, true);
                } else {
                    if (loadedImages.has(imgContainer)) {
                        img.removeAttribute("src");  // Unload image
                        loadedImages.delete(imgContainer);
                    }
                }
            });
        }, {
            rootMargin: "1000px 0px",  // Start loading before visible
            threshold: 0.01
        });

        function showModal(step) {
            modal.style.display = "block";
            Object.values(modalSteps).forEach(s => s.style.display = "none");
            modalSteps[step].style.display = "block";
        }

        function hideModal() {
            modal.style.display = "none";
        }

        function createImageElement(fileName, filePath, isWebP = false, animatedPath = null, sortValue = null) {
            const container = document.createElement("div");
            container.className = "image-container";

            const imageWrapper = document.createElement("div");
            imageWrapper.className = "image-wrapper";

            const img = document.createElement("img");
            img.alt = fileName;

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.className = "checkbox";
            
            if (sortValue) {
                const sortValueElement = document.createElement("div");
                sortValueElement.className = "sort-value";
                sortValueElement.textContent = sortValue;
                imageWrapper.appendChild(sortValueElement);
            }

            // Handle shift+click selection
            checkbox.addEventListener("click", (e) => {
                if (e.shiftKey && lastSelectedIndex >= 0) {
                    const allContainers = Array.from(document.querySelectorAll(".gallery .image-container"));
                    const currentIndex = allContainers.indexOf(container);
                    
                    // Select all images between last selected and current
                    const start = Math.min(lastSelectedIndex, currentIndex);
                    const end = Math.max(lastSelectedIndex, currentIndex);
                    
                    for (let i = start; i <= end; i++) {
                        const targetContainer = allContainers[i];
                        const targetCheckbox = targetContainer.querySelector(".checkbox");
                        targetCheckbox.checked = true;
                        targetContainer.classList.add("selected");
                    }
                }
                
                // Update last selected index
                const allContainers = Array.from(document.querySelectorAll(".gallery .image-container"));
                lastSelectedIndex = allContainers.indexOf(container);
            });
            
            checkbox.addEventListener("change", () => {
                container.classList.toggle("selected", checkbox.checked);
            });

            img.src = filePath;

            if (isWebP && animatedPath) {
                img.dataset.static = filePath;
                img.dataset.animated = animatedPath;

                container.addEventListener("mouseenter", () => {
                    img.src = img.dataset.animated; // Play animation on hover
                });

                container.addEventListener("mouseleave", () => {
                    img.src = img.dataset.static; // Return to static frame when not hovering
                });
            }

            img.addEventListener("click", (e) => {
                if (e.target.className === "checkbox") return;
                lightboxImg.src = isWebP && animatedPath ? img.dataset.animated : img.src;
                lightbox.style.display = "flex";
            });

            imageWrapper.appendChild(img);
            container.appendChild(imageWrapper);
            container.appendChild(checkbox);
            return container;
        }

        const fileMetadataCache = {}; // Object to store metadata indexed by directory and filename

        async function loadMore() {
            if (loading || done) return;
            loading = true;
            document.getElementById("loading").style.display = "block";

            const response = await fetch(`/files?dir=${currentDir}&page=${page}&sort_by=${sortBy.value}&sort_dir=${sortDir.value}`);
            const data = await response.json();

            if (data.files.length === 0) {
                document.getElementById("loading").innerText = "No more files.";
                done = true;
                loading = false;
                return;
            }

            data.files.forEach(file => {
                const fileName = file.name;
                const fileExt = fileName.split('.').pop().toLowerCase();
                const isWebP = fileExt === 'webp';
                const filePath = isWebP ? `/static-frame/${fileName}` : `/${currentDir}/${fileName}`;
                const animatedPath = isWebP ? `/${currentDir}/${fileName}` : null;

                // Store metadata in the cache
                const cacheKey = `${currentDir}_${fileName.replace(/\./g, '_')}`;
                fileMetadataCache[cacheKey] = file;

                let sortValue = null;
                if (sortBy.value === "date") {
                    sortValue = new Date(file.last_modified).toLocaleString();
                } else if (sortBy.value === "filename") {
                    sortValue = fileName;
                } else if (sortBy.value === "size") {
                    sortValue = formatFileSize(file.size_bytes || 0);
                }

                const container = createImageElement(fileName, filePath, isWebP, animatedPath, sortValue);
                gallery.appendChild(container);
            });

            page++;
            loading = false;

            // Check if enough images are loaded to create a scrollbar
            const viewportHeight = window.innerHeight;
            const contentHeight = document.body.scrollHeight;
            if (contentHeight <= viewportHeight && !done) {
                loadMore(); // Continue loading more images if no scrollbar yet
            }
        }

        function switchDirectory(dir) {
            currentDir = dir;
            page = 0;
            done = false;
            gallery.innerHTML = ""; // Clear current gallery
            loadMore(); // Load new directory contents

            // Update heading and button states without losing sort controls
            const sortControlsElement = document.getElementById("sort-controls");
            const directoryName = dir === "webp" ? "Gallery" : "Uploads Directory";
            
            // Set the heading text but preserve the sort controls by wrapping in a span
            mainHeading.innerHTML = `
                <span>${directoryName}</span>
            `;
            
            // Re-append the sort controls to the heading
            mainHeading.appendChild(sortControlsElement);

            galleryBtn.classList.toggle("active", dir === "webp");
            uploadsBtn.classList.toggle("active", dir === "uploads");

            // Show or hide upload control
            dropArea.classList.toggle("visible", dir === "uploads");
        }

        function formatFileSize(size) {
            if (size < 1024) return `${size} B`;
            if (size < 1024 * 1024) return `${(size / 1024).toFixed(2)} KB`;
            if (size < 1024 * 1024 * 1024) return `${(size / (1024 * 1024)).toFixed(2)} MB`;
            return `${(size / (1024 * 1024 * 1024)).toFixed(2)} GB`;
        }

        galleryBtn.addEventListener("click", () => switchDirectory("webp"));
        uploadsBtn.addEventListener("click", () => switchDirectory("uploads"));

        // Close lightbox on click
        lightbox.addEventListener("click", () => {
            lightbox.style.display = "none";
            lightboxImg.src = "";
            lightboxInfo.innerText = ""; // Clear info text
        });

        // Initial load
        loadMore();

        // Infinite scroll
        window.addEventListener("scroll", () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 300) {
                loadMore();
            }
        });

        const fileElem = document.getElementById('fileElem');
        const uploadStatus = document.getElementById('upload-status');

        dropArea.addEventListener('click', () => fileElem.click());

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });
        dropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
        });
        dropArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            await uploadFiles(files);
        });
        fileElem.addEventListener('change', async (e) => {
            const files = e.target.files;
            await uploadFiles(files);
        });

        async function uploadFiles(files) {
            const formData = new FormData();
            for (const file of files) {
                formData.append('file', file);
            }
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            uploadStatus.innerText = result.message;

            if (response.ok) {
                for (const file of files) {
                    const fileExt = file.name.split('.').pop().toLowerCase();
                    const isWebP = fileExt === 'webp';
                    const filePath = `/uploads/${file.name}`;
                    const animatedPath = isWebP ? `/uploads/${file.name}` : null;
                    const container = createImageElement(file.name, filePath, isWebP, animatedPath);
                    gallery.appendChild(container);
                }
            }
        }

        document.getElementById("toolbar").addEventListener("click", (e) => {
            if (e.target.closest("#select-all-btn")) {
                // Select all images
                document.querySelectorAll(".gallery .image-container").forEach(container => {
                    const checkbox = container.querySelector(".checkbox");
                    checkbox.checked = true;
                    container.classList.add("selected");
                });
            } else if (e.target.closest("#clear-selection-btn")) {
                // Clear selection
                document.querySelectorAll(".gallery .image-container").forEach(container => {
                    const checkbox = container.querySelector(".checkbox");
                    checkbox.checked = false;
                    container.classList.remove("selected");
                });
            } else if (e.target.closest("#zip-selected-btn")) {
                showModal("zipFilenameStep"); // Show zip filename input step
            } else if (e.target.closest("#delete-selected-btn")) {
                const selectedFiles = Array.from(document.querySelectorAll(".gallery .image-container.selected img"))
                    .map(img => img.alt);
                if (selectedFiles.length === 0) {
                    alert("No files selected.");
                    return;
                }

                // Show delete confirmation modal
                showModal("deleteConfirmation");

                const deleteBtn = document.getElementById("delete-btn");
                deleteBtn.onclick = async () => {
                    hideModal();
                    await deleteFiles(selectedFiles);
                };
            }
        });

        zipBtn.addEventListener("click", async () => {
            const filename = zipFilenameInput.value.trim(); // Use zipFilenameInput
            if (!filename) {
                alert("Please enter a filename.");
                return;
            }

            // Start zipping process
            showModal("zipProgressStep");

            const selectedFiles = Array.from(document.querySelectorAll(".gallery .image-container.selected img"))
                .map(img => img.alt);

            const response = await fetch("/zip", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filename, files: selectedFiles, directory: currentDir }) // Include directory in request
            });

            const result = await response.json();
            if (result.success) {
                showModal("zipDownloadStep");

                downloadBtn.onclick = () => {
                    window.location.href = `/download/${result.filename}`;
                    hideModal();
                };
            } else {
                modalTitle.innerText = "Error Zipping Files"; // Use modalTitle
                modalProgress.style.display = "none";
            }
        });

        async function deleteFiles(files) {
            const response = await fetch("/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ files, directory: currentDir })
            });
            const result = await response.json();
            if (result.success) {
                // Remove deleted files from gallery
                result.deleted.forEach(filename => {
                    const imgContainer = Array.from(gallery.children).find(container => {
                        const img = container.querySelector("img");
                        return img && img.alt === filename;
                    });
                    if (imgContainer) {
                        gallery.removeChild(imgContainer);
                    }
                });
                alert(result.message);
            } else {
                alert("Error deleting files: " + result.message);
            }
        }

        // Close modal when clicking outside
        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                hideModal();
            }
        });

        lightboxImg.addEventListener("load", () => {
            const filename = lightboxImg.src.split("/").pop();
            const cacheKey = `${currentDir}_${filename.replace(/\./g, '_')}`;
            const fileMetadata = fileMetadataCache[cacheKey];

            if (fileMetadata) {
                const resolution = fileMetadata.resolution ? `${fileMetadata.resolution}` : "";
                const frames = fileMetadata.frames ? `${fileMetadata.frames} frames` : "";
                const duration = fileMetadata.duration_seconds ? `${fileMetadata.duration_seconds.toFixed(2)}s` : "";
                const frameRate = fileMetadata.frame_rate ? `${fileMetadata.frame_rate.toFixed(2)} fps` : "";
                const fileSize = fileMetadata.size_bytes ? formatFileSize(fileMetadata.size_bytes) : "";
                const lastModified = fileMetadata.last_modified ? new Date(fileMetadata.last_modified).toLocaleString() : "";

                lightboxInfo.innerText = [filename, resolution, frames, duration, frameRate, fileSize, lastModified]
                    .filter(Boolean) // Remove empty strings
                    .join(" | ");
            } else {
                lightboxInfo.innerText = filename;
            }
        });

        sortBy.addEventListener("change", () => reloadGallery());
        sortDir.addEventListener("change", () => reloadGallery());

        async function reloadGallery() {
            page = 0;
            done = false;
            gallery.innerHTML = ""; // Clear current gallery
            loadMore(); // Reload gallery with updated sort parameters
        }
    </script>
</body>
</html>